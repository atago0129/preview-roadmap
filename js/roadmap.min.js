!function(){function i(a){switch(a.type){case"people":return a.taskGroup;case"task":return a.group;case"group":return a.name}}function j(a,b,c){f(i(a),b.getBBox().y,c)}var a={},b={},c={},d=function(){a={},b={},c={}},e=function(a){var b=a.getBoundingClientRect();return b.top+"0"+b.left},f=function(d,e,f){if(a[f].length>0){var g=c[f];g.style.minHeight=g.clientHeight+"px",g.innerHTML="",d&&(e=e<150?0:e-150,g.innerHTML="<a style='margin: 5px; margin-top: "+e+"px; display: inline-block; float: right; border-radius: 3px; color: #fff; font-size: 12px; background: #999; padding: 6px 20px 6px 20px; text-decoration: none;' href='javascript:' onclick='Roadmap.refresh(null, null,"+f+")'>&larr; 戻る</a>");var i=g.getAttribute("data-graph-type"),j={};"all"!==i&&"task"!==i||(j=h(f,g,a[f].filter(function(a){return!d||a.group===d}),{})),"all"!==i&&"people"!==i||(b[f].sort(function(a,b){return(a.group>b.group)-(a.group<b.group)}),b[f].length>0&&h(f,g,b[f].filter(function(a){return!d||a.taskGroup===d}),j))}},g=function(){var d=function(b){var c=["#3366cc","#dc3912","#ff9900","#109618","#990099","#0099c6","#dd4477","#66aa00","#b82e2e","#316395","#994499","#22aa99","#aaaa11","#6633cc","#e67300","#8b0707","#651067","#329262","#5574a6","#3b3eac"];return c[b%c.length]},g=d3.time.format("%Y-%m-%d");d3.selectAll("div.roadmap").each(function(){var h=e(this);a[h]=[],b[h]=[];for(var l,i={},j=(this.textContent||this.innerHTML||"").split("\n"),k=0;l=j[k],k<j.length;k++){var m;if(l=l.replace(/^\s+|\s+$/g,""),i.name||i.group)if(i.from||i.to)if(""===l)""===l&&i.name&&(i.group=i.group?i.group:i.name,a[h].push(i),i={});else{var n,o;n=l.match(/\s+(\d+)%\s*$/),n?(o=parseInt(n[1],10),l=l.substring(0,l.length-n[0].length).trim()):o=100,b[h].push({type:"people",group:l,from:i.from,to:i.to,name:i.group?i.name+"("+i.group+")":i.name,taskGroup:i.group,color:""===i.group?"#3182bd":d(i.group.charCodeAt(0)),involvement:o})}else m=l.replace(/[^0-9\-\/]+/," ").split(" "),i.from=g.parse(m[0]),i.to=g.parse(m[1]),i.to.setHours(i.to.getHours()+24);else m=l.split(","),i.type="task",i.group=m.slice(0,-1).join(",").trim(),i.name=m.slice(-1).join(",").trim(),i.style=i.group.match(/^\*/)?"bold":"normal",i.group=i.group.replace(/^\*\s+/,""),i.color=""===i.group?"#3182bd":d(i.group.charCodeAt(0))}c[h]=this,f(null,null,h)})},h=function(a,b,c,d){var e=20,f=e+4,g=20+(d.topPadding||0),h=c.length*f+40,i=b.clientWidth,k=d.svg||d3.select(b).append("svg").attr("width",i).attr("style","overflow: visible");k.attr("height",function(){return parseInt(k.attr("height")||0,10)+h}),c.sort(function(a,b){return a.group===b.group?a.from>b.from?1:-1:a.group>b.group?1:-1}),c=c.map(function(a){return a.group=a.group,a});for(var l=[],m=0,n=0;n<c.length;n++){for(var o=0,p=!1;o<l.length&&!p;)p=l[o].name===c[n].group,o++;if(!p){var q=0;for(o=0;o<c.length;)c[o].group===c[n].group&&q++,o++;l.push({type:"group",name:c[n].group,count:q,previous:m,style:c[n].style}),m+=q}}var r=0;for(n=0;n<c.length;n++)"people"===c[n].type&&100!==c[n].involvement&&(k.append("defs").append("pattern").attr({id:"pattern"+r,width:"8",height:"8",patternUnits:"userSpaceOnUse",patternTransform:"rotate(45)"}).append("rect").attr({width:Math.ceil(8*c[n].involvement/100),height:"8",transform:"translate(0,0)",fill:c[n].color,"fill-opacity":.8}),c[n].pattern="url(#pattern"+r+")",r++);k.append("g").selectAll("rect").data(l).enter().append("rect").attr("rx",3).attr("ry",3).attr("x",0).attr("y",function(a){return a.previous*f+g}).attr("width",function(){return i}).attr("height",function(a){return a.count*f-4}).attr("stroke","none").attr("fill","#999").attr("fill-opacity",.1);var s=k.append("g").selectAll("text").data(l).enter().append("text").text(function(a){return a.name.replace(/^\[\d*\]/g,"")}).attr("x",10).attr("y",function(a){return a.count*f/2+a.previous*f+g+2}).attr("font-size",11).attr("font-weight",function(a){return a.style}).attr("text-anchor","start").attr("text-height",14).attr("fill","#000"),t=d.sidePadding||s[0].parentNode.getBBox().width+15,u=d3.time.scale().clamp(!0).domain([d3.min(c,function(a){return a.from}),d3.max(c,function(a){return a.to})]).range([0,i-t-15]),v=d3.svg.axis().scale(u).orient("top").ticks(d3.time.month,1).tickSize(-k.attr("height")+g+20,0,0).tickFormat(d3.time.format("%-m月%-d日")),w=d3.svg.axis().scale(u).orient("bottom").ticks(d3.time.month,1).tickSize(-k.attr("height")+g+20,0,0).tickFormat(d3.time.format("%-m月%-d日")),x=k.append("g").attr("transform","translate("+t+", "+(k.attr("height")-h)+")").call(v),y=k.append("g").attr("transform","translate("+t+", "+(k.attr("height")-20)+")").call(w),z=new Date;z>u.domain()[0]&&z<u.domain()[1]&&(y.append("line").attr("x1",u(z)).attr("y1",0).attr("x2",u(z)).attr("y2",-k.attr("height")+g+20).attr("class","now"),y.selectAll(".now").attr("stroke","red").attr("opacity",.5).attr("stroke-dasharray","2,2").attr("shape-rendering","crispEdges")),x.selectAll("text").style("text-anchor","middle").attr("fill","#000").attr("stroke","none").attr("font-size",10).attr("dy","1em"),y.selectAll("text").style("text-anchor","middle").attr("fill","#000").attr("stroke","none").attr("font-size",10).attr("dy","1em"),x.selectAll(".tick line").attr("stroke","#dddddd").attr("shape-rendering","crispEdges"),y.selectAll(".tick line").attr("stroke","#dddddd").attr("shape-rendering","crispEdges");var A=k.append("g").attr("transform","translate("+t+", 0)").selectAll("rect").data(c).enter();A.append("rect").attr("rx",3).attr("ry",3).attr("x",function(a){return u(a.from)}).attr("y",function(a,b){return b*f+g}).attr("width",function(a){return u(a.to)-u(a.from)}).attr("height",e).attr("stroke","none").attr("fill",function(a){return a.pattern||a.color}).attr("fill-opacity",.5).on("mouseover",function(){d3.select(this).style({cursor:"pointer"})}).on("click",function(b){j(b,this,a)}),A.append("text").text(function(a){return a.name}).attr("x",function(a){return u(a.from)+(u(a.to)-u(a.from))/2}).attr("y",function(a,b){return b*f+14+g}).attr("font-size",11).attr("font-weight",function(a){return a.style}).attr("text-anchor","middle").attr("text-height",e).attr("fill","#000").style("pointer-events","none");var B=k.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0).style("stroke","black").style("stroke-width","1px").style("stroke-dasharray","2,2").style("shape-rendering","crispEdges").style("pointer-events","none").style("display","none"),C=k.append("rect").attr("rx",3).attr("ry",3).attr("width",50).attr("height",e).attr("stroke","none").attr("fill","black").attr("fill-opacity",.8).style("display","none"),D=k.append("text").attr("font-size",11).attr("font-weight","bold").attr("text-anchor","middle").attr("text-height",e).attr("fill","white").style("display","none"),E=40;return k.on("mousemove",function(){var a=d3.mouse(this)[0],b=d3.mouse(this)[1];a>t?(B.attr("x1",a).attr("y1",10).attr("x2",a).attr("y2",k.attr("height")-20).style("display","block"),C.attr("x",a-25).attr("y",b-(e+8)/2+E).style("display","block"),D.attr("transform","translate("+a+","+(b+E)+")").text(d3.time.format("%-m月%-d日")(u.invert(a-t))).style("display","block")):(B.style("display","none"),C.style("display","none"),D.style("display","none"))}),k.on("mouseleave",function(){B.style("display","none"),C.style("display","none"),D.style("display","none")}),{sidePadding:t,topPadding:h,svg:k}};document.addEventListener("DOMContentLoaded",function(){void 0===window.Roadmap&&(g(),window.Roadmap={parse:g,refresh:f,reset:d})})}();